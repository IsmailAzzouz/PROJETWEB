<!-- game_grid.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tic-Tac-Toe Game</title>
    <style>
      /* Your styles here */
      body {
        margin: 0;
        padding: 0;
      }

      .GameScene {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100vh; /* Set the height of the container, adjust as needed */
        margin: 0;
      }

      #GameGrid {
        display: grid;
        width: 85%;
        height: 75%;

        grid-template-columns: repeat({{game_y}}, minmax(0, 1fr));
        grid-template-rows: repeat({{game_x}}, minmax(0, 1fr));
        gap: 5px;
        /**/ /*****/
      }

      .GridCell {
        box-sizing: border-box;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #000;
        padding: 10px;
        text-align: center;
        font-size: 24px;
        cursor: pointer;
      }

      h1 {
        margin-top: 20px;
        text-align: center;
      }

      fieldset {
        margin-top: 20px;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <h1>Tic-Tac-Toe Game</h1>
    <h1>
    {{ player_1 }}
</h1>
 <h1>
    {{ player_2 }}
</h1>
    <div id="GameGrid"></div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
    let gridX = {{ game_x }};
    let gridY = {{ game_y }};
    let gameBoard = Array.from({ length: gridX }, () => Array(gridY).fill(''));
    let prevGameBoard = Array.from({ length: gridX }, () => Array(gridY).fill(''));
    let currentPlayer = "{{current_user_role}}" === "Player 1" ? "0" : "1";
    const gameId = '{{ game_idcode }}';

    function areGridsEqual(grid1, grid2) {
        for (let i = 0; i < gridX; i++) {
            for (let j = 0; j < gridY; j++) {
                if (grid1[i][j] !== grid2[i][j]) {
                    return false;
                }
            }
        }
        return true;
    }

    function updateCellInDatabase(row, col, symbol) {
        const csrfToken = '{{ csrf_token }}';
        const moveData = {
            row: row,
            col: col,
            symbol: symbol,
            csrfmiddlewaretoken: csrfToken,
        };
        const updateCellUrl = '{% url "update_cell_in_database" game_idcode=game_idcode %}';
        const url = `${updateCellUrl}?game_idcode=${gameId}`;

        $.ajax({
            url: url,
            method: 'POST',
            data: {
                row: row,
                col: col,
                symbol: symbol,
                csrfmiddlewaretoken: csrfToken,
                game_idcode: gameId,
            },
            success: function (response) {
                // Handle the server response as needed
            },
            error: function () {
                alert('Error updating the cell in the database. Please try again.');
            },
        });
    }

    function updateGrid() {
        for (let i = 0; i < gridX; i++) {
            for (let j = 0; j < gridY; j++) {
                const cellValue = getCellValueFromDatabase(i, j);
                const cellElement = $(`[data-row="${i}"][data-col="${j}"]`);

                if (cellValue === -1 || cellValue === '') {
                    cellElement.text('');
                } else {
                    cellElement.text(cellValue === '0' ? 'X' : 'O');
                }
            }
        }
    }

    function checkWin() {
        for (let i = 0; i < gridX; i++) {
            if (
                gameBoard[i][0] !== '' &&
                gameBoard[i].every((cell) => cell === gameBoard[i][0])
            ) {
                return true;
            }
        }

        for (let i = 0; i < gridY; i++) {
            if (
                gameBoard[0][i] !== '' &&
                gameBoard.every((row) => row[i] === gameBoard[0][i])
            ) {
                return true;
            }
        }

        if (
            gameBoard[0][0] !== '' &&
            gameBoard.every((row, index) => row[index] === gameBoard[0][0])
        ) {
            return true;
        }

        if (
            gameBoard[0][gridY - 1] !== '' &&
            gameBoard.every(
                (row, index) => row[gridY - 1 - index] === gameBoard[0][gridY - 1]
            )
        ) {
            return true;
        }

        return false;
    }

    function checkDraw() {
        return gameBoard.every((row) => row.every((cell) => cell !== ''));
    }

    function switchPlayer() {
        currentPlayer = (currentPlayer === '0') ? '1' : '0';
    }

    $(document).ready(function () {
        const gameId = '{{ game_idcode }}';

        function createGrid() {
            $('#GameGrid').empty();

            for (let i = 0; i < gridX; i++) {
                for (let j = 0; j < gridY; j++) {
                    const newCell = $(`<div class="GridCell" data-row="${i}" data-col="${j}"></div>`);
                    $('#GameGrid').append(newCell);

                    let cellValue = getCellValueFromDatabase(i, j);

                    if (cellValue === -1 || cellValue === '') {
                        newCell.text('');
                    } else {
                        newCell.text(cellValue === '0' ? 'X' : 'O');
                    }
                }
            }
        }

        $('#GameGrid').on('click', '.GridCell', function () {
            const row = parseInt($(this).attr('data-row'));
            const col = parseInt($(this).attr('data-col'));

            if (!areGridsEqual(gameBoard, prevGameBoard)) {
                alert("Wait for the other player to make a move.");
                return;
            }

            if (gameBoard[row][col] === '') {
                gameBoard[row][col] = currentPlayer === '0' ? 'X' : 'O';
                updateGrid();
                updateCellInDatabase(row, col, currentPlayer);

                prevGameBoard = gameBoard.map(row => row.slice());

                if (checkWin()) {
                    alert(`Player ${currentPlayer === '0' ? '1' : '2'} wins!`);
                } else if (checkDraw()) {
                    alert('It\'s a draw!');
                } else {
                    switchPlayer();
                }
            } else {
                alert('Cell already taken! Choose another.');
            }
        });

        function refreshGrid() {
            createGrid();
            updateGrid();
        }

        setInterval(refreshGrid, 10);
    });

    function getCellValueFromDatabase(row, col) {
        const csrfToken = '{{ csrf_token }}';
        let cellValue = -1;
        const getCellValueFromDatabaseUrl = '{% url "get_cell_value_from_database" game_idcode=game_idcode %}';
        const cellurl = `${getCellValueFromDatabaseUrl}?game_idcode=${gameId}`;

        $.ajax({
            url: cellurl,
            method: 'POST',
            data: {
                game_code: gameId,
                row: row,
                col: col,
                csrfmiddlewaretoken: csrfToken,
            },
            async: false,
            success: function (response) {
                if (response.cellValue !== undefined) {
                    cellValue = response.cellValue;
                } else {
                    alert('Error fetching cell value from the database. Please try again.');
                }
            },
            error: function () {
                alert('Error fetching cell value from the database. Please try again.');
            },
        });

        return cellValue;
    }
</script>


  </body>
</html>
