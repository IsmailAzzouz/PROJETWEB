<!-- game_grid.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tic-Tac-Toe Game</title>
    <style>
      /* Your styles here */
      body {
        margin: 0;
        padding: 0;
      }

      .GameScene {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100vh; /* Set the height of the container, adjust as needed */
        margin: 0;
      }

      #GameGrid {
        display: grid;
        width: 85%;
        height: 75%;

        grid-template-columns: repeat({{game_y}}, minmax(0, 1fr));
        grid-template-rows: repeat({{game_x}}, minmax(0, 1fr));
        gap: 5px;
        /**/ /*****/
      }

      .GridCell {
        box-sizing: border-box;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #000;
        padding: 10px;
        text-align: center;
        font-size: 24px;
        cursor: pointer;
      }

      h1 {
        margin-top: 20px;
        text-align: center;
      }

      fieldset {
        margin-top: 20px;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <h1>Tic-Tac-Toe Game</h1>

    <div id="GameGrid"></div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
          let gridX = {{ game_x }};
          let gridY = {{ game_y }};
          let gameBoard = Array.from({ length: gridX }, () => Array(gridY).fill(''));
          let currentPlayer = 0;
      const gameId = '{{ game_idcode }}';
          // Function to update the visual representation of the grid
           function updateCellInDatabase(row, col, symbol) {
              // Implement the logic to update the cell in the database
              // You can use Ajax to send a request to the server to update the database
              // The server should handle the database update based on the move data (row, col, symbol)
              const csrfToken = '{{ csrf_token }}';
              const moveData = {
                  row: row,
                  col: col,
                  symbol: symbol,
                  csrfmiddlewaretoken: csrfToken,

              };
      const updateCellUrl = '{% url "update_cell_in_database" game_idcode=game_idcode %}';

                const url = `${updateCellUrl}?game_idcode=${gameId}`;



              $.ajax({
                  url: url,
                  method: 'POST',
                  data: {
                      row: row,
                      col: col,
                      symbol: symbol,
                      csrfmiddlewaretoken: csrfToken,
                      game_idcode: gameId,  // Pass the game_idcode in the data
                  },
                  success: function (response) {
                      // Handle the server response as needed
                  },
                  error: function () {
                      alert('Error updating the cell in the database. Please try again.');
                  },
              });
          }
      function updateGrid() {
              for (let i = 0; i < gridX; i++) {
                  for (let j = 0; j < gridY; j++) {
                      const cellValue = getCellValueFromDatabase(i, j);
                      const cellElement = $(`[data-row="${i}"][data-col="${j}"]`);
                      //console.log("grid updated");
                      if (cellValue === -1 || cellValue==='') {
                          cellElement.text('');  // Empty cell
                          //console.log("empty cell");
                      } else {
                          cellElement.text(cellValue === '0' ? 'X' : 'O');
                          //console.log("cell not empty");
                      }
                  }
              }
          }

          // Function to check for a win
          function checkWin() {
              for (let i = 0; i < gridX; i++) {
                  if (
                      gameBoard[i][0] !== '' &&
                      gameBoard[i].every((cell) => cell === gameBoard[i][0])
                  ) {
                      return true; // Win in row
                  }
              }

              for (let i = 0; i < gridY; i++) {
                  if (
                      gameBoard[0][i] !== '' &&
                      gameBoard.every((row) => row[i] === gameBoard[0][i])
                  ) {
                      return true; // Win in column
                  }
              }

              if (
                  gameBoard[0][0] !== '' &&
                  gameBoard.every((row, index) => row[index] === gameBoard[0][0])
              ) {
                  return true; // Win in top-left to bottom-right diagonal
              }

              if (
                  gameBoard[0][gridY - 1] !== '' &&
                  gameBoard.every(
                      (row, index) => row[gridY - 1 - index] === gameBoard[0][gridY - 1]
                  )
              ) {
                  return true; // Win in top-right to bottom-left diagonal
              }

              return false;
          }

          // Function to check for a draw
          function checkDraw() {
              return gameBoard.every((row) => row.every((cell) => cell !== ''));
          }

          // Function to switch players
          function switchPlayer() {
              currentPlayer = 1 - currentPlayer;
                  // alert(currentPlayer + "tes dans switchplayer");
          }

          // Function to update the cells in the database

          $(document).ready(function () {
              const gameId = '{{ game_idcode }}';

              // Function to create the grid
              function createGrid() {
              $('#GameGrid').empty();

              for (let i = 0; i < gridX; i++) {
                  for (let j = 0; j < gridY; j++) {
                      const newCell = $(`<div class="GridCell" data-row="${i}" data-col="${j}"></div>`);
                      $('#GameGrid').append(newCell);

                      // Get cell value from the database
                      let cellValue = getCellValueFromDatabase(i, j);
                              //console.log(cellValue);
                      // Display the cell value based on the database value
                      if (cellValue === -1 || cellValue==='') {
                          newCell.text('');  // Empty cell
                      } else {
                          console.log(cellValue + "\n"+newCell)
                          newCell.text(cellValue === '0' ? 'X' : 'O');
                      }

                  }
              }
          }

              // Use event delegation to handle clicks on dynamic cells
              $('#GameGrid').on('click', '.GridCell', function () {
                  const row = parseInt($(this).attr('data-row'));
                  const col = parseInt($(this).attr('data-col'));
                  $('.GridCell').on('click',function(){

                  })
                  if (gameBoard[row][col] === '') {
                      gameBoard[row][col] = currentPlayer === '0' ? 'X' : 'O';
                      //ICI GERE QUAND ON CLIQUE
                      // Update the grid
                      console.log("gameboard " + gameBoard[row][col]);
                      updateGrid();

                      // Update the cell in the database

                      updateCellInDatabase(row, col, currentPlayer);

                      if (checkWin()) {
                          alert(`Player ${currentPlayer + 1} wins!`);
                          // Reset the game or perform any other action
                      } else if (checkDraw()) {
                          alert('It\'s a draw!');
                          // Reset the game or perform any other action
                      } else {
                          switchPlayer();
                          //alert("tes dans le else");
                          console.log(currentPlayer + "current player");
                      }
                  } else {
                      alert('Cell already taken! Choose another.');
                  }
              });

              // Call createGrid function to generate the grid
              createGrid();

              // Your other JavaScript code
              function refreshGrid() {
              createGrid();
              updateGrid();
          }

          // Use setInterval to refresh the grid every 0.5 seconds
          setInterval(refreshGrid, 10000);
          });function getCellValueFromDatabase(row, col) {
              // Implement logic to fetch the cell value from the database based on row and col
              // Return -1 if the cell is empty, 0 if it belongs to Player 1, 1 if it belongs to Player 2
              //const url = '{% url "get_cell_value_from_database" game_idcode=game_idcode %}';
              const csrfToken = '{{ csrf_token }}';
              let cellValue = -1;  // Default value if not found
              const getCellValueFromDatabaseUrl = '{% url "get_cell_value_from_database" game_idcode=game_idcode %}';
              //console.log(row , col);
              const cellurl = `${getCellValueFromDatabaseUrl}?game_idcode=${gameId}`;
              $.ajax({
                  url: cellurl,
                  method: 'POST',

                  data: {
                      game_code: gameId,
                      row: row,
                      col: col,
                      csrfmiddlewaretoken: csrfToken,


                        // Pass the game_idcode in the data
                  },
                  async: false,  // Ensure synchronous request to get the value before updating
                  success: function (response) {
          // Check if cellValue is defined before using it
          if (response.cellValue !== undefined) {
              cellValue = response.cellValue;
          } else {
              // Handle the case where cellValue is not defined
              alert('Error fetching cell value from the database. Please try again.');
          }
      },
                  error: function () {
                      alert('Error fetching cell value from the database. Please try again.');
                  },
              });

              return cellValue;
          }
    </script>
  </body>
</html>
